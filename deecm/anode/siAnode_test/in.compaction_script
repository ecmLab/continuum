#------------------General Settings for Granular Systems--------------------------------------------
# Update the MATLAB so that the walls take up the full square no hex patten
atom_style      granular
atom_modify     map array
boundary        f f f
newton          off
communicate     single vel yes
units           micro
neighbor        0.001 bin
neigh_modify    every 1 delay 0 check yes
echo            both
timestep        5.e-6

# Target pressures for compaction
variable        tarp        equal     100
variable        tarp1       equal     300
variable        tarp2       equal     300

#--------------------------Material Information---------------------------------------------------------
# Coefficient of restitution
variable        cf_11         equal     0.1     # AM-AM
variable        cf_22         equal     0.1     # CC1-CC1
variable        cf_33         equal     0.1     # SE-SE
variable        cf_44         equal     0.1     # Wall-Wall
variable        cf_55         equal     0.1     # Ghost-Ghost
variable        cf_66         equal     0.1     # CC2-CC2
variable        cf_12         equal     0.1     # AM-CC1
variable        cf_13         equal     0.1     # AM-SE
variable        cf_14         equal     0.1     # AM-Wall
variable        cf_15         equal     0.1     # AM-Ghost
variable        cf_16         equal     0.1     # AM-CC2
variable        cf_23         equal     0.1     # CC1-SE
variable        cf_24         equal     0.1     # CC1-Wall
variable        cf_25         equal     0.1     # CC1-Ghost
variable        cf_26         equal     0.1     # CC1-CC2
variable        cf_34         equal     0.1     # SE-Wall
variable        cf_35         equal     0.1     # SE-Ghost
variable        cf_36         equal     0.1     # SE-CC2
variable        cf_45         equal     0.1     # Wall-Ghost
variable        cf_46         equal     0.1     # Wall-CC2
variable        cf_56         equal     0.1     # Ghost-CC2

# Coefficient of friction
variable        cof_all       equal     0.1     # Same for all pairs

# Coefficient of rolling friction
variable        corf_all      equal     0.1     # Same for all pairs

# Young's modulus
variable        Yam           equal     48.5e6    # AM (Active Material) [kPa] (From paper Si)
variable        Ycc           equal     50.e6  # CC1 and CC2 (Current Collectors) [kPa]
variable        Yse           equal     23.e6  # SE (Solid Electrolyte) [kPa] (From Paper LPS)
variable        Yww           equal     50.e6    # Wall [kPa]
variable        Yghost        equal     50.e6    # Ghost particles [kPa]

variable        particle_poissons_ratio equal 0.4

#---------------------Read Initial Configuration----------------------------------------
read_data        mdl_high_density.data

# Define groups based on particle types
group  cc2   type  6   # Current Collector 2 (top/lithium)
group  se    type  3   # Solid Electrolyte
group  ghost type  5   # Ghost layer (separator)
group  am    type  1   # Active Material
group  cc1   type  2   # Current Collector 1 (bottom)

group  ptc   type  1 3 # Types effected by walls

#---------------------Assign Material Properties----------------------------------------
fix     m1 all property/global youngsModulus peratomtype ${Yam} ${Ycc} ${Yse} ${Yww} ${Yghost} ${Ycc}
fix     m2 all property/global poissonsRatio peratomtype ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio}

# Coefficient of restitution matrix (6x6)
fix     m3 all property/global coefficientRestitution peratomtypepair 6 &
        ${cf_11} ${cf_12} ${cf_13} ${cf_14} ${cf_15} ${cf_16} &
        ${cf_12} ${cf_22} ${cf_23} ${cf_24} ${cf_25} ${cf_26} &
        ${cf_13} ${cf_23} ${cf_33} ${cf_34} ${cf_35} ${cf_36} &
        ${cf_14} ${cf_24} ${cf_34} ${cf_44} ${cf_45} ${cf_46} &
        ${cf_15} ${cf_25} ${cf_35} ${cf_45} ${cf_55} ${cf_56} &
        ${cf_16} ${cf_26} ${cf_36} ${cf_46} ${cf_56} ${cf_66}

# Coefficient of friction matrix (6x6) - using same value for all
fix     m4 all property/global coefficientFriction peratomtypepair 6 &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all}

# Coefficient of rolling friction matrix (6x6) - using same value for all
fix     m5 all property/global coefficientRollingFriction peratomtypepair 6 &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all}

# Cohesion energy density (6x6)
fix     m6 all property/global cohesionEnergyDensity peratomtypepair 6 &
        100000  50000  100000  0       0   50000   &
        50000   0      50000   0       0   0       &
        100000  50000  100000  0       0   50000   &
        0       0      0       0       0   0       &
        0       0      0       0       0   0       &
        50000   0      50000   0       0   0

#---------------------Define Pair Style and Walls----------------------------------------
pair_style gran model hertz tangential history cohesion sjkr
pair_coeff * *

# Wall boundaries
fix xwalls1 ptc wall/gran model hertz tangential history primitive type 4 xplane -10
fix xwalls2 ptc wall/gran model hertz tangential history primitive type 4 xplane 10
fix ywalls1 ptc wall/gran model hertz tangential history primitive type 4 yplane -10
fix ywalls2 ptc wall/gran model hertz tangential history primitive type 4 yplane 10
fix zwalls1 ptc wall/gran model hertz tangential history primitive type 4 zplane 0
fix zwalls2 ptc wall/gran model hertz tangential history primitive type 4 zplane 75

#---------------------Apply NVE Integration----------------------------------------
fix integr all nve/sphere

# Warn if timestep > 10% of Rayleigh time or 10% of Hertz time
fix ts_check all check/timestep/gran 1000 0.1 0.1 warn yes

#------------------------Output Settings------------------------------------------------------
# Compute forces and positions for different layers
compute        ker    all    erotate/sphere            # Compute the rotational kinetic energy of all particles
compute        frc    ghost  reduce sum fz             # Total force in Z of ghost layer picograms * micrometers / microsecond^2 (nN) Layer that compacts the SE
compute        frc1   cc1    reduce sum fz             # Total force in Z of cc1 (nano Newtons) Layer that compacts composite cathode
compute        posw   ghost  reduce ave z              # Position in Z of ghost (micro meters)
compute        posw1  cc1    reduce ave z              # Position in Z of cc1 (micro meters)

variable       prs    equal  -(c_frc)*2.5e-6    # Pressure on ghost in MPa (force(nN)/400area(um^2))
variable       prs1   equal  -(c_frc1)*2.5e-6   # Pressure on cc1 in unit of MPa
variable       posz   equal  (c_posw)          # Position in Z of ghost (micro meters)
variable       posz1  equal  (c_posw1)         # Position in Z of cc1 (micro meters)

variable       ts_rayleigh equal f_ts_check[1]
variable       ts_hertz    equal f_ts_check[2]
variable       ts_skin     equal f_ts_check[3]

thermo_style    custom step atoms ke c_ker vol v_prs c_posw v_prs1 c_posw1 v_ts_rayleigh v_ts_hertz v_ts_skin
thermo          1000
thermo_modify   lost ignore norm no

# Optional: Dump for visualization
dump    dmp_final all custom 50000 post_c300_10/compact_*.txt id type x y z vx vy vz fx fy fz omegax omegay omegaz radius

#------------------------Compaction Process------------------------------------------------------
fix 3 ghost move linear 0 0 0.2
fix 4 cc2 move linear 0 0 0 # Fixing top

### Run calculation
# 1. Run first period: move ghost up until pressure growth
label loop1
  run   10000
  if "${prs} > ${tarp}" then "jump SELF loop2"
jump SELF loop1

# 2. Run second period: hold so that kinetic energy decrease
label loop2
fix 3 ghost move linear 0 0 0.0
run 1000000
fix 3 ghost move linear 0 0 -0.02

label loop10
  run  10000
  if "${prs} < 1" then "jump SELF loop101"
jump SELF loop10

label loop101
fix 3 ghost move linear 0 0 0.0
fix 5 cc1 move linear 0 0 0.2

label loop11
  run   10000
  if "${prs1} > ${tarp1}" then "jump SELF loop3"
jump SELF loop11

label loop3
  delete_atoms group ghost

# 3. Run third period: decrease pressing velocity so that pressure value converge more accurate to designed value
label loop4
  fix 5 cc1 move linear 0 0 0.01
  run 5000
  if "${prs1} > ${tarp2}" then "jump SELF loop5"
  jump SELF loop4

# 4. Run forth period: hold for relax
label loop5
fix 5 cc1 move linear 0 0 0.0
run 100000
if "${prs1} < ${tarp1}" then "jump SELF loop3"

run 100000

#------------------------Relax Process------------------------------------------------------
fix 5 cc1 move linear 0 0 -0.2

# 5. Run fifth period: move bottom layer downward until pressure decrease
label loop6
  run   5000
  if "${prs1} < 10" then "jump SELF loop7"
jump SELF loop6

# Hold so that kinetic energy decrease
label loop7

fix 5 cc1 move linear 0 0 0.0

run 100000

# Save compacted state
write_restart   comp300_bat_10MPa.restart
write_data      comp300_bat_10MPa.data