#------------------General Settings for Granular Systems--------------------------------------------
# Update the MATLAB so that the walls take up the full square no hex patten
atom_style      granular
atom_modify     map array
boundary        f f f
newton          off
communicate     single vel yes
units           micro
neighbor        0.001 bin
neigh_modify    every 1 delay 0 check yes
echo            both
timestep        5.e-6

# Target pressures for compaction
variable        tarp        equal     190
variable        tarp1       equal     200

#--------------------------Material Information---------------------------------------------------------
# Coefficient of restitution
variable        cor_all       equal     0.1     # Same for all pairs

# Coefficient of friction
variable        cof_all       equal     0.1     # Same for all pairs

# Coefficient of rolling friction
variable        corf_all      equal     0.1     # Same for all pairs

# Young's modulus
variable        Yse           equal     23.e6  # SE (Solid Electrolyte) [kPa] (From Paper LPS)
variable        Yli           equal     10.e6  # Li (Lithium Metal) [kPa] (From Paper LPS)
variable        Ycc           equal     120.e6  # Li (Lithium Metal) [kPa] (https://www.azom.com/properties.aspx?ArticleID=597)
variable        Yww           equal     50.e6    # Wall [kPa]

variable        particle_poissons_ratio equal 0.4

#---------------------Read Initial Configuration----------------------------------------
read_data        data/mdl_sym_pack_2.data

# Define groups based on particle types (Type 6 is the wall)
group  acc   type  5   # Current Collector (top)
group  ali   type  3   # Lithium 2 (top)
group  se    type  1   # Solid Electrolyte
group  cli   type  2   # Lithium 1 (bottom)
group  ccc   type  4   # Current Collector (bottom)

group  ptc   type  1 2 3 # Types effected by walls

#---------------------Assign Material Properties----------------------------------------
fix     m1 all property/global youngsModulus peratomtype ${Yse} ${Yli} ${Yli} ${Ycc} ${Ycc} ${Yww}
fix     m2 all property/global poissonsRatio peratomtype ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio}

# Coefficient of restitution matrix (6x6)
fix     m3 all property/global coefficientRestitution peratomtypepair 6 &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all}

# Coefficient of friction matrix (6x6) - using same value for all
fix     m4 all property/global coefficientFriction peratomtypepair 6 &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} 

# Coefficient of rolling friction matrix (6x6) - using same value for all
fix     m5 all property/global coefficientRollingFriction peratomtypepair 6 &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} 

# Cohesion energy density (6x6)
fix     m6 all property/global cohesionEnergyDensity peratomtypepair 6 &
        50000  70000  70000  10000 10000 0 &
        70000  70000  70000  10000 10000 0 &
        70000  70000  70000  10000 10000 0 &
        10000  10000  10000  0     0     0 &
        10000  10000  10000  0     0     0 &
        0       0       0    0     0     0 

#---------------------Define Pair Style and Walls----------------------------------------
pair_style gran model hertz tangential history cohesion sjkr
pair_coeff * *

# Wall boundaries
fix xwalls1 ptc wall/gran model hertz tangential history primitive type 6 xplane -10
fix xwalls2 ptc wall/gran model hertz tangential history primitive type 6 xplane 10
fix ywalls1 ptc wall/gran model hertz tangential history primitive type 6 yplane -10
fix ywalls2 ptc wall/gran model hertz tangential history primitive type 6 yplane 10
fix zwalls1 ptc wall/gran model hertz tangential history primitive type 6 zplane 0
fix zwalls2 ptc wall/gran model hertz tangential history primitive type 6 zplane 89

#---------------------Apply NVE Integration----------------------------------------
fix integr all nve/sphere

# Warn if timestep > 10% of Rayleigh time or 10% of Hertz time
fix ts_check all check/timestep/gran 1000 0.1 0.1 warn yes

#------------------------Output Settings------------------------------------------------------
# Compute forces and positions for different layers
compute        ker    all    erotate/sphere            # Compute the rotational kinetic energy of all particles
compute        frc1   ccc    reduce sum fz             # Total force in Z of ccc (nano Newtons) Layer that compacts SE
compute        posw1  ccc    reduce ave z              # Position in Z of ccc (micro meters)

variable       prs1   equal  -(c_frc1)*2.5e-6   # Pressure on ccc in unit of MPa
variable       posz1  equal  (c_posw1)         # Position in Z of ccc (micro meters)

variable       ts_rayleigh equal f_ts_check[1]
variable       ts_hertz    equal f_ts_check[2]
variable       ts_skin     equal f_ts_check[3]

thermo_style    custom step atoms ke c_ker vol v_prs1 c_posw1 v_ts_rayleigh v_ts_hertz v_ts_skin
thermo          1000
thermo_modify   lost ignore norm no

# Optional: Dump for visualization
dump    dmp_final all custom 50000 post_c200_sym_pack_2/compact_*.txt id type x y z vx vy vz fx fy fz omegax omegay omegaz radius

#------------------------Compaction Process------------------------------------------------------
fix 1 acc move linear 0 0 0 # Fixing top
fix 2 ccc move linear 0 0 0.2 # Moving bottom li up

### Run calculation
label loop1
  run   10000
  if "${prs1} > ${tarp}" then "jump SELF loop2"
jump SELF loop1

label loop2

# Run period: decrease pressing velocity so that pressure value converge more accurate to designed value
label loop3
  fix 2 ccc move linear 0 0 0.01
  run 5000
  if "${prs1} > ${tarp1}" then "jump SELF loop4"
  jump SELF loop3

# Run period: hold for relax
label loop4
fix 2 ccc move linear 0 0 0.
run 100000
if "${prs1} < ${tarp1}" then "jump SELF loop2"

run 100000

# Save compacted state
write_restart   data/comp200_sym_pack_2.restart
write_data      data/comp200_sym_pack_2.data