# Battery simulation using pre-compacted particles from restart file
# With type-based boundary conditions for SOR solver
# SE particles (type 1) - Solid Electrolyte
# CCC particles (type 2) - Lithium Layer 1 (Bottom)
# ACC particles (type 3) - Lithium Layer 2 (top)
# Wall particles (type 4) - Walls
# Run with fix_battery_eis_CC_temp active


# --- 1. INITIALIZATION ---
units           micro  # Using micro units to match the compaction script
atom_style      granular
atom_modify     map array
boundary        f f f  # Fixed boundaries as in compaction script
newton          off

communicate     single vel yes

# Set timestep (Do not change radius update optimized for this value)
timestep        5.e-6

# --- 2. READ RESTART FILE ---
# Read the compacted configuration
read_data     data/comp200_sym_pack_2.data

# --- 3. RE-ESTABLISH GROUPS ---
# Define groups based on particle types (Type 6 is the wall)
group  acc   type  5   # Current Collector (top)
group  ali   type  3   # Lithium 2 (top)
group  se    type  1   # Solid Electrolyte
group  cli   type  2   # Lithium 1 (bottom)
group  ccc   type  4   # Current Collector (bottom)

group  ptc   type  1 2 3 # Types effected by walls
group  li    type  2 3 # Lithium type

# --- 4. NEIGHBOR SETTINGS ---
neighbor        0.001 bin
neigh_modify    every 1 delay 0 check yes

# --- 5. RE-ESTABLISH MATERIAL PROPERTIES ---
# Young's modulus (from compaction script)
variable        Yse           equal     23.e6  # SE (Solid Electrolyte) [kPa] (From Paper LPS)
variable        Yli           equal     10.e6  # Li (Lithium Metal) [kPa] (From Paper LPS)
variable        Ycc           equal     120.e6  # Li (Lithium Metal) [kPa] (https://www.azom.com/properties.aspx?ArticleID=597)
variable        Yww           equal     50.e6    # Wall [kPa]

variable        particle_poissons_ratio equal 0.4

# Material properties
fix     m1 all property/global youngsModulus peratomtype ${Yse} ${Yli} ${Yli} ${Ycc} ${Ycc} ${Yww}
fix     m2 all property/global poissonsRatio peratomtype ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio}

# Coefficient of restitution matrix (4x4)
variable        cor_all       equal     0.1     # Same for all pairs
fix     m3 all property/global coefficientRestitution peratomtypepair 6 &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all}

# Coefficient of friction (all 0.1 from compaction)
variable        cof_all       equal     0.1     # Same for all pairs
fix     m4 all property/global coefficientFriction peratomtypepair 6 &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} 

# Coefficient of rolling friction (all 0.1 from compaction)
variable        corf_all      equal     0.1     # Same for all pairs
fix     m5 all property/global coefficientRollingFriction peratomtypepair 6 &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} 

# Cohesion energy density (from compaction script)
fix     m6 all property/global cohesionEnergyDensity peratomtypepair 6 &
        50000  70000  70000  10000 10000 0 &
        70000  70000  70000  10000 10000 0 &
        70000  70000  70000  10000 10000 0 &
        10000  10000  10000  0     0     0 &
        10000  10000  10000  0     0     0 &
        0       0       0    0     0     0 

# --- 6. PAIR STYLE AND WALLS ---
pair_style gran model hertz tangential history cohesion sjkr
pair_coeff * *

# Re-establish wall boundaries (from compaction script)
fix xwalls1 ptc wall/gran model hertz tangential history primitive type 6 xplane -10
fix xwalls2 ptc wall/gran model hertz tangential history primitive type 6 xplane 10
fix ywalls1 ptc wall/gran model hertz tangential history primitive type 6 yplane -10
fix ywalls2 ptc wall/gran model hertz tangential history primitive type 6 yplane 10
fix zwalls1 ptc wall/gran model hertz tangential history primitive type 6 zplane 50.0193
fix zwalls2 ptc wall/gran model hertz tangential history primitive type 6 zplane 87.375

# --- 7. INTEGRATION ---
fix             integr all nve/sphere
# unfix           integr

# Warn if timestep > 10% of Rayleigh time or 10% of Hertz time
fix             ts_check all check/timestep/gran 1 0.1 0.1 warn no

# --- 8. ANALYSIS SETUP ---
# Get current positions of different layers
compute         z_ccc_avg ccc reduce ave z
compute         z_se_avg se reduce ave z
compute         z_acc_avg acc reduce ave z

# Print layer information
variable        z_ccc equal c_z_ccc_avg
variable        z_se equal c_z_se_avg
variable        z_acc equal c_z_acc_avg

# Count particles
variable        n_ccc equal count(ccc)
variable        n_se equal count(se)
variable        n_acc equal count(acc)

# FIXED Top Layer (acc) from moving
fix 1 acc move linear 0 0 0
# Initial ccc velocity - will be adjusted by pressure control loop
fix 2 ccc move linear 0 0 0

# --- 8.5. PRESSURE COMPUTATION ON CCC ---
compute         frc1    ccc    reduce sum fz        # Force on ccc layer
variable        prs1    equal  -(c_frc1)*2.5e-6     # Pressure on ccc layer [MPa]

# Create a per-atom variable that holds the value of prs1
variable        prs1_atom atom v_prs1

# Hydrostatic Stress Initializing
compute      st li stress/atom

# --- 8.6. PRESSURE MAINTENANCE SETTINGS ---
# Target pressure bounds for stack pressure maintenance (MPa)
variable        tarp_low   equal 195
variable        tarp_high  equal 205
variable        press_vel  equal 2.0   # Velocity for pressure adjustment [um/us]

# --- 9. BATTERY PHYSICS MODELS ---

# Initialize lithium content (Li/Si molar ratio) - only for AM particles
fix             li_content li property/atom/lithium_content initial 1.0 target 1.0 max 1.0

#fix battery_eis_sym all battery/eis omega 1.0 tolerance 1e-1 max_iter 10 &
#    BC_types 2 3 4 5 &           # Li_Ctype Li_Atype CC_Ctype CC_Atype
#    BC_potentials 0.0 1.0 &    # phi_ref(V) i_app(A/mÂ²)
#    conductivity 0.05 0.1 &    # sigma_SE sigma_Li (S/m)
#    SE_type 1

# CC: SOR solver for electric potential with type-based boundary conditions (cathode anode) condutivity (AM, SE, CC)
fix             battery_eis_sym all battery/eis omega 1.0 tolerance 1e-1 max_iter 1 &
                BC_types 2 3 4 5 &        
                BC_potentials 0.0 1.0 &
                conductivity 0.05 0.1 & 
                SE_type 1

# CV: SOR solver for electric potential with type-based boundary conditions (anode cathode) condutivity (AM, SE, CC)
#fix             battery_eis_sym all battery/eis omega 1.0 tolerance 1e-1 max_iter 1 &
#                BC_types 3 2 BC_potentials -0.005 0.005 conductivity 0.05 SE_type 1

# Lithium diffusion - only for AM particles
fix             li_diffusion li lithium_diffusion Li_type 3 2 c_li_max 77101.002

# Radius expansion for Si particles (optional)
fix             radius_expand li radius_expansion Li_type 3 2 update_every 1 max_updates 1e10

# --- 10. COMPUTE SETUP FOR MONITORING ---
# Electrolyte potential by material type
compute         phi_el_se_avg se reduce ave f_electrolytePotential
compute         phi_el_cli_avg cli reduce ave f_electrolytePotential
compute         phi_el_ali_avg ali reduce ave f_electrolytePotential
compute         phi_el_ccc_avg ccc reduce ave f_electrolytePotential
compute         phi_el_acc_avg acc reduce ave f_electrolytePotential

# Current flow tracking
compute         current_avg_ali ali reduce ave f_currentLiSE
compute         current_avg_cli cli reduce ave f_currentLiSE

# Cell voltage: difference between top and bottom CC
variable        cell_voltage equal c_phi_el_acc_avg-c_phi_el_ccc_avg

variable       ts_rayleigh equal f_ts_check[1]
variable       ts_hertz    equal f_ts_check[2]
variable       ts_skin     equal f_ts_check[3]

# --- 11. OUTPUT SETTINGS ---
# Thermo output
thermo_style    custom step atoms ke &
                c_phi_el_ccc_avg c_phi_el_cli_avg c_phi_el_se_avg &
                c_phi_el_ali_avg c_phi_el_acc_avg v_cell_voltage c_current_avg_ali c_current_avg_cli &
                v_ts_rayleigh v_ts_hertz v_ts_skin v_prs1
thermo          90
thermo_modify   lost ignore norm no

# Dump for visualization
dump            dmp_battery all custom 1440 20251217_CCD_post_bat_sym_200Mpa_pack_30min_10h_1Am2_dt0d1s_SP200/battery_*.txt id type x y z vx vy vz fx fy fz omegax omegay omegaz radius &
                f_electrolytePotential f_electronicPotential f_currentLiSE f_hydrostaticStress v_prs1_atom

# --- 12. PRESSURE-CONTROLLED RUN ---
# Initial run to initialize computes before pressure control loop
run 1

# Loop counter for 1000 iterations x 360 steps = 360,000 total steps
# 1 Time step is 
variable loop_iter loop 1000

label loop_pressure
  # If pressure too low (electrode expansion), compress by moving ccc up
  if "${prs1} < ${tarp_low}" then "fix 2 ccc move linear 0 0 ${press_vel}"
  # If pressure too high, release by moving ccc down
  if "${prs1} > ${tarp_high}" then "fix 2 ccc move linear 0 0 -${press_vel}"
  # If pressure in acceptable range, hold position
  if "${prs1} >= ${tarp_low}" then "if '${prs1} <= ${tarp_high}' then 'fix 2 ccc move linear 0 0 0'"
  
  run 360
  next loop_iter
jump SELF loop_pressure