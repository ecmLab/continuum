#------------------General Settings for Granular Systems--------------------------------------------
# Update the MATLAB so that the walls take up the full square no hex patten
atom_style      granular
atom_modify     map array
boundary        f f f
newton          off
communicate     single vel yes
units           micro
neighbor        0.001 bin
neigh_modify    every 1 delay 0 check yes
echo            both
timestep        5.e-6

# Target pressures for compaction
variable        tarp        equal     40
variable        tarp1       equal     50

#--------------------------Material Information---------------------------------------------------------
# Coefficient of restitution
variable        cor_all       equal     0.1     # Same for all pairs

# Coefficient of friction
variable        cof_all       equal     0.1     # Same for all pairs

# Coefficient of rolling friction
variable        corf_all      equal     0.1     # Same for all pairs

# Young's modulus
variable        Yse           equal     23.e6  # SE (Solid Electrolyte) [kPa] (From Paper LPS)
variable        Yli           equal     10.e6  # Li (Lithium Metal) [kPa] (From Paper LPS)
variable        Yww           equal     50.e6    # Wall [kPa]

variable        particle_poissons_ratio equal 0.4

#---------------------Read Initial Configuration----------------------------------------
read_data        data/mdl_lisym_slim2.data

# Define groups based on particle types (Type 4 is the wall)
group  li2   type  3   # Lithium 2 (top)
group  se    type  1   # Solid Electrolyte
group  li1   type  2   # Lithium 1 (bottom)

group  ptc   type  1 # Types effected by walls

#---------------------Assign Material Properties----------------------------------------
fix     m1 all property/global youngsModulus peratomtype ${Yse} ${Yli} ${Yli} ${Yww}
fix     m2 all property/global poissonsRatio peratomtype ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio} ${particle_poissons_ratio}

# Coefficient of restitution matrix (4x4)
fix     m3 all property/global coefficientRestitution peratomtypepair 4 &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} 

# Coefficient of friction matrix (4x4) - using same value for all
fix     m4 all property/global coefficientFriction peratomtypepair 4 &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all}

# Coefficient of rolling friction matrix (4x4) - using same value for all
fix     m5 all property/global coefficientRollingFriction peratomtypepair 4 &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all}

# Cohesion energy density (4x4)
fix     m6 all property/global cohesionEnergyDensity peratomtypepair 4 &
        50000   100000  100000  0 &
        100000  0       0       0 &
        100000  0       0       0 &
        0       0       0       0

#---------------------Define Pair Style and Walls----------------------------------------
pair_style gran model hertz tangential history cohesion sjkr
pair_coeff * *

# Wall boundaries
fix xwalls1 ptc wall/gran model hertz tangential history primitive type 4 xplane -10
fix xwalls2 ptc wall/gran model hertz tangential history primitive type 4 xplane 10
fix ywalls1 ptc wall/gran model hertz tangential history primitive type 4 yplane -10
fix ywalls2 ptc wall/gran model hertz tangential history primitive type 4 yplane 10
fix zwalls1 ptc wall/gran model hertz tangential history primitive type 4 zplane 0
fix zwalls2 ptc wall/gran model hertz tangential history primitive type 4 zplane 78

#---------------------Apply NVE Integration----------------------------------------
fix integr all nve/sphere

# Warn if timestep > 10% of Rayleigh time or 10% of Hertz time
fix ts_check all check/timestep/gran 1000 0.1 0.1 warn yes

#------------------------Output Settings------------------------------------------------------
# Compute forces and positions for different layers
compute        ker    all    erotate/sphere            # Compute the rotational kinetic energy of all particles
compute        frc1   li1    reduce sum fz             # Total force in Z of li1 (nano Newtons) Layer that compacts SE
compute        posw1  li1    reduce ave z              # Position in Z of li1 (micro meters)

variable       prs1   equal  -(c_frc1)*2.5e-6   # Pressure on li1 in unit of MPa
variable       posz1  equal  (c_posw1)         # Position in Z of li1 (micro meters)

variable       ts_rayleigh equal f_ts_check[1]
variable       ts_hertz    equal f_ts_check[2]
variable       ts_skin     equal f_ts_check[3]

thermo_style    custom step atoms ke c_ker vol v_prs1 c_posw1 v_ts_rayleigh v_ts_hertz v_ts_skin
thermo          1000
thermo_modify   lost ignore norm no

# Optional: Dump for visualization
dump    dmp_final all custom 50000 post_c50_sym_slim2/compact_*.txt id type x y z vx vy vz fx fy fz omegax omegay omegaz radius

#------------------------Compaction Process------------------------------------------------------
fix 1 li2 move linear 0 0 0 # Fixing top
fix 2 li1 move linear 0 0 0.2 # Moving bottom li up

### Run calculation
label loop1
  run   10000
  if "${prs1} > ${tarp}" then "jump SELF loop2"
jump SELF loop1

label loop2

# Run period: decrease pressing velocity so that pressure value converge more accurate to designed value
label loop3
  fix 2 li1 move linear 0 0 0.01
  run 5000
  if "${prs1} > ${tarp1}" then "jump SELF loop4"
  jump SELF loop3

# Run period: hold for relax
label loop4
fix 2 li1 move linear 0 0 0.
run 100000
if "${prs1} < ${tarp1}" then "jump SELF loop2"

run 100000

# Save compacted state
write_restart   data/comp50_sym_slim2.restart
write_data      data/comp50_sym_slim2.data