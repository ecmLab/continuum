# Battery simulation using pre-compacted particles from data file
# With type-based boundary conditions for SOR solver
# Metal particles (type 1) - Metal Particles
# Carbon particles (type 2) - Carbon Particles
# SE Layer (type 3) - SE Particles (Top)
# Li Source Layer (type 4) - Li Particles (Bottom)
# Wall particles (type 5) - Walls

# --- 1. INITIALIZATION ---
units           micro  # Using micro units to match the compaction script
atom_style      granular
atom_modify     map array
boundary        f f f  # Fixed boundaries as in compaction script
newton          off

communicate     single vel yes

# Set timestep (Do not change radius update optimized for this value)
timestep        5.e-6

# --- 2. READ RESTART FILE ---
# Read the compacted configuration
read_data     data/1L_M2C5_vr5_pack.data

# --- 3. RE-ESTABLISH GROUPS ---
# Define groups based on particle types (Type 5 is the wall)
group  me    type  1   # Metal
group  cb    type  2   # Carbon
group  se    type  3   # SE Layer (top)
group  li    type  4   # Li Layer (bottom)

# Groups for particles affected by walls
group  ptc   type  1 2 # Types affected by walls

# --- 4. NEIGHBOR SETTINGS ---
neighbor        0.001 bin
neigh_modify    every 1 delay 0 check yes

# --- 5. RE-ESTABLISH MATERIAL PROPERTIES ---
variable        Eme           equal     76.e6  # Metal (Ag) [kPa] (MatWeb - Silver, Ag)
variable        vme           equal     0.37    # Metal (Ag) [-] (MatWeb - Silver, Ag)

variable        Ecb           equal     15.e6  # Carbon (AB) [kPa] (https://www.azom.com/properties.aspx?ArticleID=516)
variable        vcb           equal     0.20    # Carbon (AB) [-] (https://www.azom.com/properties.aspx?ArticleID=516)

variable        Ese           equal     22.1e6  # SE (Li6PS5Cl) [kPa] (http://dx.doi.org/10.1149/2.0061602jes)
variable        vse           equal     0.37    # SE (Li6PS5Cl) [-] (http://dx.doi.org/10.1149/2.0061602jes)

variable        Eli           equal     7.82e6  # Li (Li-metal) [kPa] (https://doi.org/10.1007/s10853-018-2971-3)
variable        vli           equal     0.381    # Li (Li-metal) [-] (https://doi.org/10.1007/s10853-018-2971-3)

variable        Eww           equal     100.e6    # Wall [kPa]
variable        vww           equal     0.4      # Wall [-]

# Material properties
fix     m1 all property/global youngsModulus peratomtype ${Eme} ${Ecb} ${Ese} ${Eli} ${Eww}
fix     m2 all property/global poissonsRatio peratomtype ${vme} ${vcb} ${vse} ${vli} ${vww}

# Coefficient of restitution matrix (5x5)
variable        cor_all       equal     0.1     # Same for all pairs
fix     m3 all property/global coefficientRestitution peratomtypepair 5 &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all} &
        ${cor_all} ${cor_all} ${cor_all} ${cor_all} ${cor_all}

# Coefficient of friction (5x5)
variable        cof_all       equal     0.1     # Same for all pairs
fix     m4 all property/global coefficientFriction peratomtypepair 5 &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all} &
        ${cof_all} ${cof_all} ${cof_all} ${cof_all} ${cof_all}

# Coefficient of rolling friction (5x5)
variable        corf_all      equal     0.1     # Same for all pairs
fix     m5 all property/global coefficientRollingFriction peratomtypepair 5 &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all} &
        ${corf_all} ${corf_all} ${corf_all} ${corf_all} ${corf_all}

# Cohesion energy density (5x5) (Randomly Assigned Pairs Based on Average)
fix     m6 all property/global cohesionEnergyDensity peratomtypepair 5 &
        50000   70000   60000   100000  0 &
        70000   90000   80000   110000  0 &
        60000   80000   70000   100000  0 &
        100000  110000  100000  120000  0 &
        0       0       0       0       0

# --- 6. PAIR STYLE AND WALLS ---
pair_style gran model hertz tangential history cohesion sjkr
pair_coeff * *

# Re-establish wall boundaries (from compaction script)
fix xwalls1 ptc wall/gran model hertz tangential history primitive type 5 xplane 0.0
fix xwalls2 ptc wall/gran model hertz tangential history primitive type 5 xplane 2.5
fix ywalls1 ptc wall/gran model hertz tangential history primitive type 5 yplane 0.0
fix ywalls2 ptc wall/gran model hertz tangential history primitive type 5 yplane 2.5
fix zwalls1 ptc wall/gran model hertz tangential history primitive type 5 zplane 0.0
fix zwalls2 ptc wall/gran model hertz tangential history primitive type 5 zplane 2.5

# --- 7. INTEGRATION ---
fix             integr all nve/sphere

# Warn if timestep > 10% of Rayleigh time or 10% of Hertz time
fix             ts_check all check/timestep/gran 1 0.1 0.1 warn no

# --- 8. ANALYSIS SETUP ---

# FIXED Top and Bottom Layer from moving
fix 1 se move linear 0 0 0  # Top Layer
fix 2 li move linear 0 0 0  # Bottom Layer

# --- 8.5. PRESSURE COMPUTATION ON SE ---
compute         frc    li    reduce sum fz      # Force in [nN]
variable        prs    equal  -(c_frc)*160.e-6  # Pressure in [MPa] 

# Create a per-atom variable that holds the value of prs1
variable        prs_atom atom v_prs

# Hydrostatic Stress Initializing
compute      st li stress/atom

# --- 9.0. ELECTROCHEMICAL COMPUTATIONS ---

# Initialize lithium content (Li/Metal molar ratio) - only for AM particles
fix             li_content me property/atom/lithium_content initial 0.0 target 1.0 max 1.0

# Calculate equilibrium potential - only for AM particles
# fix             eq_pot me equilibrium_potential temperature 303. x_max 1.0 material Ag

# SOR solver for potential with type-based boundary conditions (cathode anode) condutivity (AM, SE, CC)
fix             potential_sol all potential/sor omega 1.0 max_iter 1 &
                BC_types 3 4 BC_potentials 0.00 0.00 0.0 conductivity 0.05 0.1 SE_type 2

# Lithium diffusion - only for AM particles
fix             diff all lithium_diffusion AM_type 1 CB_type 2 LM_type 4 &
                c_li_max_LM 77101.002 c_li_max_AM 115917.8 c_li_max_CB 23332.2 &
                D_AM_AM 1.0e-15 D_AM_CB 1.0e-15 D_AM_LM 1.0e-14 &
                D_CB_AM 1.0e-15 D_CB_CB 1.0e-15 D_CB_LM 1.0e-14

# Radius expansion for AM particles (optional - Omega_Li_CB is smaller b/c saying volume doesnt change much with Li content )
fix             radexp all radius_expansion AM_type 1 CB_type 2 update_every 1 max_updates 1000000 &
                Omega_Li_AM 6.0593e-6 Omega_Li_CB 4.9307e-6

# --- 10. COMPUTE SETUP FOR MONITORING ---

# Electric potential by material type - NOW ELECTROLYTE POTENTIAL
#compute         phi_el_se_avg se reduce ave f_electrolytePotential

# Electronic potential by material type
#compute         phi_ed_se_avg se reduce ave f_electronicPotential

# Current flow at AM-SE interfaces
compute         current_avg se reduce ave f_currentLiSE

variable       ts_rayleigh equal f_ts_check[1]
variable       ts_hertz    equal f_ts_check[2]
variable       ts_skin     equal f_ts_check[3]

# --- 11. OUTPUT SETTINGS ---
# Thermo output
thermo_style    custom step atoms ke &
                v_ts_rayleigh v_ts_hertz v_ts_skin v_prs
thermo          30
thermo_modify   lost ignore norm no

# Dump for visualization
dump            dmp_batt all custom 30 6_20260112_1C_M2C5_vr5_rest_5min/battery_*.txt id type x y z vx vy vz fx fy fz omegax omegay omegaz radius &
                f_electrolytePotential f_electronicPotential f_currentLiSE f_hydrostaticStress f_lithiumContent f_lithiumConcentration f_lithiumMols v_prs_atom

# 4. Run EC for 1 timestep, equivelent to 0.1s real seconds
run             3000  # 5min